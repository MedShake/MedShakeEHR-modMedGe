-- upgrade n° de version
UPDATE `system` SET `value`='v1.3.0' WHERE `name`='medge';

-- ajustement form pour autosize
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'medGeAtcdPersoMedicaux,rows=3', 'medGeAtcdPersoMedicaux,rows=2') where internalName = 'medGeATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'medGeAtcdPersoChirugicaux,rows=3', 'medGeAtcdPersoChirugicaux,rows=2') where internalName = 'medGeATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'medGeAtcdFamiliaux,rows=3', 'medGeAtcdFamiliaux,rows=2') where internalName = 'medGeATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'allergies,rows=3', 'allergies,rows=1') where internalName = 'medGeATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, '- job', '- job,rows=1') where internalName = 'medGeATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, '- toxiques', '- toxiques,rows=1') where internalName = 'medGeATCD';

UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'medGeSynthesePatient,rows=8', 'medGeSynthesePatient,rows=2') where internalName = 'medGeSynthesePatient';

UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'medGeSyntheseGrossesse,rows=5', 'medGeSyntheseGrossesse,rows=2') where internalName = 'medGeSyntheseObs';

UPDATE `forms` SET `javascript` ='$(document).ready(function() {\r\n\r\n  //calcul IMC\r\n  if ($(\'#id_imc_id\').length > 0) {\r\n\r\n    imc = imcCalc($(\'#id_poids_id\').val(), $(\'#id_taillePatient_id\').val());\r\n    if (imc > 0) {\r\n      $(\'#id_imc_id\').val(imc);\r\n    }\r\n\r\n    $(\"#patientLatCol\").on(\"keyup\", \"#id_poids_id , #id_taillePatient_id\", function() {\r\n      poids = $(\'#id_poids_id\').val();\r\n      taille = $(\'#id_taillePatient_id\').val();\r\n      imc = imcCalc(poids, taille);\r\n      $(\'#id_imc_id\').val(imc);\r\n      patientID = $(\'#identitePatient\').attr(\"data-patientID\");\r\n      setPeopleDataByTypeName(imc, patientID, \'imc\', \'#id_imc_id\', \'0\');\r\n\r\n    });\r\n  }\r\n\r\n  //ajutement auto des textarea en hauteur\r\n  autosize($(\'#formName_medGeATCD textarea\')); \r\n  \r\n  ////////////////////////////////////////////////////////////////////////\r\n  ///////// Gestion Allergies\r\n\r\n  // ajout Allergies\r\n  $(\"#patientLatCol\").on(\"click\", \"button.getAllergiesPanel\", function(e) {\r\n    e.preventDefault();\r\n    $(\'#texteRechercheAllergie\').attr(\'data-parentid\', $(this).attr(\'data-parentid\'));\r\n  });\r\n  $(\'#searchAllergie\').on(\'shown.bs.modal\', function() {\r\n    $(\"#texteRechercheAllergie\").val(\'\');\r\n    $(\'#codeAllergietrouves\').html(\'\');\r\n    $(\"#texteRechercheAllergie\").focus();\r\n  })\r\n\r\n  // interogation sur mot clé\r\n  $(\"#texteRechercheAllergie\").typeWatch({\r\n    wait: 1000,\r\n    highlight: false,\r\n    allowSubmit: false,\r\n    captureLength: 3,\r\n    callback: function(value) {\r\n      $.ajax({\r\n        url: urlBase + \'/lap/ajax/allergieSearch/\',\r\n        type: \'post\',\r\n        data: {\r\n          term: value,\r\n          parentid: $(\'#texteRechercheAllergie\').attr(\'data-parentid\')\r\n        },\r\n        dataType: \"html\",\r\n        beforeSend: function() {\r\n          $(\'#codeAllergietrouves\').html(\'<div class=\"col-md-12\">Attente des résultats de la recherche ...</div>\');\r\n        },\r\n        success: function(data) {\r\n          $(\'#codeAllergietrouves\').html(data);\r\n        },\r\n        error: function() {\r\n          alert(\'Problème, rechargez la page !\');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  // ajouter allergie\r\n  $(\"#searchAllergie\").on(\"click\", \"button.addAllergieToPatient\", function(e) {\r\n    origin = $(this);\r\n    label = $(this).attr(\'data-label\');\r\n    $.ajax({\r\n      url: urlBase + \'/lap/ajax/allergieAdd/\',\r\n      type: \'post\',\r\n      data: {\r\n        patientID: $(\'#identitePatient\').attr(\"data-patientID\"),\r\n        codeAller: $(this).attr(\'data-code\'),\r\n        libelleAller: label,\r\n        parentID: $(this).attr(\'data-parentid\')\r\n      },\r\n      dataType: \"json\",\r\n      success: function(data) {\r\n        if (data[\'statut\'] == \'ok\') {\r\n          origin.closest(\'tr\').addClass(\"success\");\r\n          origin.attr(\'disabled\', \'disabled\');\r\n          $(\"#atcdTableauAllergieStruc\").removeClass(\'d-none\');\r\n          $(\"#atcdTableauAllergieStruc tbody\").append(\'<tr class=\"tr{{ id }} table-warning small\"><td>\' + label + \'</td></tr>\');\r\n        } else {\r\n          alert(\'Problème, rechargez la page !\');\r\n        }\r\n      },\r\n      error: function() {\r\n        alert(\'Problème, rechargez la page !\');\r\n      }\r\n    });\r\n  });\r\n\r\n  // retirer allergie\r\n  $(\"#patientLatCol\").on(\"click\", \"button.removeAllergie\", function(e) {\r\n    e.preventDefault();\r\n    origin = $(this);\r\n    objetid = $(this).attr(\'data-objetid\');\r\n    $.ajax({\r\n      url: urlBase + \'/lap/ajax/allergieDel/\',\r\n      type: \'post\',\r\n      data: {\r\n        patientID: $(\'#identitePatient\').attr(\"data-patientID\"),\r\n        objetID: objetid\r\n      },\r\n      dataType: \"json\",\r\n      success: function(data) {\r\n        if (data[\'statut\'] == \'ok\') {\r\n          $(\"#atcdTableauAllergieStruc tr.tr\" + objetid).remove();\r\n        } else {\r\n          alert(\'Problème, rechargez la page !\');\r\n        }\r\n      },\r\n      error: function() {\r\n        alert(\'Problème, rechargez la page !\');\r\n      }\r\n    });\r\n  });\r\n\r\n});' where internalName = 'medGeATCD';
UPDATE `forms` SET `javascript` = '$(document).ready(function() {\r\n\r\n  //ajutement auto des textarea en hauteur\r\n  autosize($(\'#formName_medGeSyntheseObs textarea\')); \r\n  \r\n  // Si on change la DDR\r\n  $(\"#before_DDR\").on(\"dp.change\", function(e) {\r\n    calcAndDisplayTdj();\r\n    calcAndDisplayDdgt();\r\n    calcAndDisplayT9m();\r\n    if (typeof(dicomAutoSendPatient) != \"undefined\") {\r\n      if (dicomAutoSendPatient == true) {\r\n        prepareEcho(\'nopopup\');\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n  // Si on change la DDG retenue\r\n  $(\"#before_ddgReel\").on(\"dp.change\", function(e) {\r\n    calcAndDisplayTdj();\r\n    calcAndDisplayT9m();\r\n    if (typeof(dicomAutoSendPatient) != \"undefined\") {\r\n      if (dicomAutoSendPatient == true) {\r\n        prepareEcho(\'nopopup\');\r\n      }\r\n    }\r\n  });\r\n\r\n  //close grossesseEnCours\r\n  $(\'body\').on(\"click\", \"#closeGro\", function(e) {\r\n    if (confirm(\"Voulez-vous fermer définitivement ce suivi de grossesse ?\")) {\r\n      if (confirm(\"Confirmez-vous réellement ?\")) {\r\n\r\n      } else {\r\n        e.preventDefault();\r\n      }\r\n    } else {\r\n      e.preventDefault();\r\n    }\r\n  });\r\n\r\n  calcAndDisplayDdgt();\r\n  calcAndDisplayTdj();\r\n  calcAndDisplayT9m()\r\n});\r\n\r\n// calculer et afficher terme du jour\r\nfunction calcAndDisplayTdj() {\r\n  tdj = tdjCalc($(\'#id_DDR_id\').val(), $(\'#id_ddgReel_id\').val());\r\n  if (tdj[\'status\'] == \'ok\') {\r\n    $(\'#id_termeDuJour_id\').val(tdj[\'human\']);\r\n    $(\'#id_termeDuJour_id\').attr(\'data-tdj4math\', tdj[\'math\']);\r\n  } else {\r\n    $(\'#id_termeDuJour_id\').val(\'\');\r\n    $(\'#id_termeDuJour_id\').attr(\'data-tdj4math\', \'\');\r\n  }\r\n}\r\n\r\n// calculer et afficher terme 9 mois\r\nfunction calcAndDisplayT9m() {\r\n  t9 = terme9mCalc($(\'#id_DDR_id\').val(), $(\'#id_ddgReel_id\').val());\r\n  if (t9[\'status\'] == \'ok\') {\r\n    $(\'#id_terme9mois_id\').val(t9[\'human\']);\r\n  } else {\r\n    $(\'#id_terme9mois_id\').val(\'\');\r\n  }\r\n}\r\n\r\n\r\n//calculer et afficher DDG théo\r\nfunction calcAndDisplayDdgt() {\r\n  ddgt = ddgtCalc($(\'#id_DDR_id\').val());\r\n  $(\'#id_ddg_id\').val(ddgt);\r\n}' where internalName = 'medGeSyntheseObs';
UPDATE `forms` SET `javascript` = '$(document).ready(function() {\r\n\r\n  //bouton de nouvelle grossesse\r\n  $(\"a.newGro\").on(\"click\", function(e) {\r\n    if (!confirm(\'Voulez-vous installer un nouveau suivi de grossesse ?\')) {\r\n      e.preventDefault();\r\n    }\r\n  });\r\n  \r\n  //ajutement auto des textarea en hauteur\r\n  autosize($(\'#formName_medGeSynthesePatient textarea\')); \r\n \r\n});' where internalName = 'medGeSynthesePatient';


UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'medGeCsExamenDuJour,rows=10', 'medGeCsExamenDuJour,rows=3') where internalName = 'medGeConsultAdulte';
UPDATE `forms` SET `javascript` = '$(document).ready(function() {\r\n\r\n  //ajutement auto des textarea en hauteur\r\n  autosize($(\'#formName_medGeConsultAdulte textarea\')); \r\n\r\n});' where internalName = 'medGeConsultAdulte';

UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'medGeCsDivVaccinationNotes,row=4', 'medGeCsDivVaccinationNotes,row=2') where internalName = 'medGeConsultVaccination';
UPDATE `forms` SET `javascript` = '$(document).ready(function() {\r\n\r\n  //ajutement auto des textarea en hauteur\r\n  autosize($(\'#formName_medGeConsultVaccination textarea\')); \r\n\r\n});' where internalName = 'medGeConsultVaccination';

UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'medGeExamenObsDuJour,rows=10', 'medGeExamenObsDuJour,rows=3') where internalName = 'medGeConsultObs';
UPDATE `forms` SET `javascript` = '$(document).ready(function() {\r\n\r\n  //ajutement auto des textarea en hauteur\r\n  autosize($(\'#formName_medGeConsultObs textarea\')); \r\n\r\n});' where internalName = 'medGeConsultObs';
